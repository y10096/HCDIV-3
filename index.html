<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Average resale price bar chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .chart {
            width: 100%;
            height: 1000px; /* 高度调整为原来的两倍 */
        }
        .axis-label {
            font-size: 12px;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            border-radius: 3px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Average Resale Prices by Town, March 2012 to March 2013 Bar Chart</h1>
    <div class="chart" id="chart"></div>
    <div class="tooltip" id="tooltip"></div>

    <script>
        // 1. 加载并解析 CSV 数据
        d3.csv("https://raw.githubusercontent.com/y10096/HCDIV-3/refs/heads/main/ResaleFlatPricesBasedonRegistrationDateFromMar2012toDec2014%20(1).csv").then(function(data) {
            // 数据预处理
            let towns = new Set();
            let pricesByMonth = {};

            // 2. 处理数据，按月份和镇子计算平均价格
            // 只保留2012年3月到2013年3月的数据
            let filteredData = data.filter(d => {
                let month = new Date(d["month"]);
                return month >= new Date("2012-03-01") && month <= new Date("2013-03-31");
            });

            filteredData.forEach(d => {
                let month = d["month"];
                let town = d["town"];
                let price = +d["resale_price"];  // 确保转售价格是数字

                if (!town || !month || !price) return;

                towns.add(town);

                if (!pricesByMonth[month]) {
                    pricesByMonth[month] = {};
                }
                if (!pricesByMonth[month][town]) {
                    pricesByMonth[month][town] = [];
                }

                pricesByMonth[month][town].push(price);
            });

            // 3. 计算每个镇子的平均价格
            let avgPricesByMonth = {};
            for (let month in pricesByMonth) {
                avgPricesByMonth[month] = {};
                for (let town in pricesByMonth[month]) {
                    let prices = pricesByMonth[month][town];
                    let avgPrice = d3.mean(prices);
                    avgPricesByMonth[month][town] = avgPrice;
                }
            }

            // 获取月份的排序
            let months = Object.keys(avgPricesByMonth).sort((a, b) => new Date(a) - new Date(b));

            // 4. 设置 D3 绘图参数
            let margin = { top: 40, right: 30, bottom: 60, left: 50 },
                width = 2000 - margin.left - margin.right,  // 宽度设置为 200% 或者 2000px
                height = 1000 - margin.top - margin.bottom; // 高度设置为 1000px

            let svg = d3.select("#chart").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // 5. 创建 x 和 y 轴比例尺
            let x = d3.scaleBand()
                .domain(months)
                .range([0, width])
                .padding(0.1);

            let y = d3.scaleLinear()
                .domain([0, d3.max(Object.values(avgPricesByMonth).map(townData => d3.max(Object.values(townData))))])
                .nice()
                .range([height, 0]);

            // 6. 添加 x 轴
            svg.append("g")
                .selectAll(".x-axis")
                .data(months)
                .enter()
                .append("text")
                .attr("x", d => x(d) + x.bandwidth() / 2)
                .attr("y", height + 20)
                .attr("text-anchor", "middle")
                .text(d => d)
                .style("font-size", "12px")
                .style("transform", "rotate(-45deg)")  // 旋转标签，避免重叠
                .style("transform-origin", "center");

            // 7. 添加 y 轴
            svg.append("g")
                .call(d3.axisLeft(y))  // 绘制Y轴
                .attr("class", "y-axis");

            // 8. 绘制柱状图
            let color = d3.scaleOrdinal(d3.schemeCategory10);
            towns.forEach((town, index) => {
                let townData = months.map(month => ({
                    month: month,
                    price: avgPricesByMonth[month][town] || 0
                }));

                svg.selectAll(".bar-" + town)
                    .data(townData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d.month))
                    .attr("y", d => y(d.price))
                    .attr("width", x.bandwidth())
                    .attr("height", d => height - y(d.price))
                    .attr("fill", color(index))
                    .on("mouseover", function(event, d) {
                        d3.select("#tooltip")
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px")
                            .style("display", "inline-block")
                            .html(town + " - " + d.month + "<br/>" + "转售价格: " + d.price.toLocaleString());
                    })
                    .on("mouseout", function() {
                        d3.select("#tooltip").style("display", "none");
                    });
            });
        });
    </script>
</body>
</html>

