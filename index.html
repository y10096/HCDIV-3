<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Average resale price bar chart2.0</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .chart {
            width: 100%;
            height: 1000px;
            text-align: center;
        }
        .axis-label {
            font-size: 12px;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            border-radius: 3px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Average Resale Prices by Town, March 2012 to March 2013 Bar Chart</h1>
    <div class="chart" id="chart"></div>
    <div class="tooltip" id="tooltip"></div>

    <script>
        // 1. 加载并解析 CSV 数据
        d3.csv("https://raw.githubusercontent.com/y10096/HCDIV-3/refs/heads/main/ResaleFlatPricesBasedonRegistrationDateFromMar2012toDec2014%20(1).csv").then(function(data) {
            console.log("原始数据：", data); // 打印原始数据以检查

            // 解析日期格式： "Mar-12" -> "2012-03-01"
            let parseMonth = d3.timeParse("%b-%y");  // %b-%y: "Mar-12", "May-12"等
            let startDate = parseMonth("Mar-12");
            let endDate = parseMonth("Mar-13");

            // 数据预处理
            let towns = new Set();
            let pricesByMonth = {};

            // 2. 处理数据，按月份和镇子计算平均价格
            let filteredData = data.filter(d => {
                let month = parseMonth(d["month"]);
                return month >= startDate && month <= endDate;
            });

            console.log("筛选后的数据：", filteredData); // 打印筛选后的数据

            filteredData.forEach(d => {
                let month = d["month"];
                let town = d["town"];
                let price = +d["resale_price"];  // 确保转售价格是数字

                if (!town || !month || !price) return;

                towns.add(town);

                if (!pricesByMonth[month]) {
                    pricesByMonth[month] = {};
                }
                if (!pricesByMonth[month][town]) {
                    pricesByMonth[month][town] = [];
                }

                pricesByMonth[month][town].push(price);
            });

            // 3. 计算每个镇子的平均价格
            let avgPricesByMonth = {};
            for (let month in pricesByMonth) {
                avgPricesByMonth[month] = {};
                for (let town in pricesByMonth[month]) {
                    let prices = pricesByMonth[month][town];
                    let avgPrice = d3.mean(prices);
                    avgPricesByMonth[month][town] = avgPrice;
                }
            }

            console.log("按月平均价格：", avgPricesByMonth); // 打印按月计算的平均价格

            // 获取月份的排序
            let months = Object.keys(avgPricesByMonth).sort((a, b) => parseMonth(a) - parseMonth(b));

            // 4. 设置 D3 绘图参数
            let margin = { top: 40, right: 30, bottom: 60, left: 50 },
                width = 2000 - margin.left - margin.right,  // 宽度设置为 200% 或者 2000px
                height = 1000 - margin.top - margin.bottom; // 高度设置为 1000px

            let svg = d3.select("#chart").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // 5. 创建 x 和 y 轴比例尺
            let x = d3.scaleBand()
                .domain(months)
                .range([0, width])
                .padding(0.1);

            let y = d3.scaleLinear()
                .domain([0, d3.max(Object.values(avgPricesByMonth).map(townData => d3.max(Object.values(townData))))])
                .nice()
                .range([height, 0]);

            // 6. 添加 X 轴
            svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("font-size", "12px")
                .style("text-anchor", "middle")
                .style("transform", "rotate(-45deg)")
                .style("transform-origin", "center");

            // 7. 添加 Y 轴
            svg.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(y));

            // 8. 绘制柱状图
            let color = d3.scaleOrdinal(d3.schemeCategory10);
            towns.forEach((town, index) => {
                let townData = months.map(month => ({
                    month: month,
                    price: avgPricesByMonth[month][town] || 0
                }));

                console.log("镇子 " + town + " 的数据：", townData); // 打印每个镇的数据

                svg.selectAll(".bar-" + town)
                    .data(townData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d.month))  // X位置
                    .attr("y", d => y(d.price))  // Y位置（价格）
                    .attr("width", x.bandwidth())  // 宽度
                    .attr("height", d => height - y(d.price))  // 高度
                    .attr("fill", color(index))  // 填充颜色
                    .on("mouseover", function(event, d) {
                        d3.select("#tooltip")
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px")
                            .style("display", "inline-block")
                            .html(town + " - " + d.month + "<br/>" + "转售价格: " + d.price.toLocaleString());
                    })
                    .on("mouseout", function() {
                        d3.select("#tooltip").style("display", "none");
                    });
            });
        });
    </script>
</body>
</html>
