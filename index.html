<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>转售价格折线图</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .line {
            fill: none;
            stroke-width: 2;
        }
        .axis path, .axis line {
            fill: none;
            shape-rendering: crispEdges;
        }
        .axis text {
            font-size: 12px;
        }
        .legend {
            font-size: 12px;
        }
    </style>
</head>
<body>

<h2>2012年3月到2013年3月转售价格折线图</h2>
<svg width="960" height="500"></svg>

<script>
// 1. 载入CSV数据
d3.csv("https://raw.githubusercontent.com/y10096/HCDIV-3/refs/heads/main/ResaleFlatPricesBasedonRegistrationDateFromMar2012toDec2014%20(1).csv").then(function(data) {

    // 2. 处理数据
    const parseDate = d3.timeParse("%Y/%m/%d");

    // 过滤出特定时间范围和地区
    const selectedRegions = ["WOODLANDS", "JURONG WEST", "TAMPINES", "YISHUN", "BEDOK", "SENGKANG", "HOUGANG", "ANG MO KIO"];
    data = data.filter(d => 
        selectedRegions.includes(d.town) && 
        parseDate(d.month) >= new Date("2012-03-01") &&
        parseDate(d.month) <= new Date("2013-03-31")
    );

    // 转换价格为数字，月份为日期格式
    data.forEach(d => {
        d.resale_price = +d.resale_price; // 转换为数字
        d.month = parseDate(d.month); // 使用 d3.timeParse 解析日期
    });

    // 3. 设置图表尺寸和边距
    const margin = { top: 20, right: 30, bottom: 40, left: 40 };
    const width = 960 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    // 4. 创建SVG容器
    const svg = d3.select("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // 5. 设置X轴和Y轴的比例尺
    const x = d3.scaleTime()
        .domain(d3.extent(data, d => d.month))
        .range([0, width]);

    const y = d3.scaleLinear()
        .domain([d3.min(data, d => d.resale_price), d3.max(data, d => d.resale_price)])
        .nice()
        .range([height, 0]);

    // 6. 绘制X轴和Y轴
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x).ticks(d3.timeMonth));

    svg.append("g")
        .attr("class", "y axis")
        .call(d3.axisLeft(y).ticks(5));

    // 7. 创建一个字典，用于存储每个地区的数据
    const regions = d3.nest()
        .key(d => d.town)
        .entries(data);

    // 8. 创建折线图
    const line = d3.line()
        .x(d => x(d.month))
        .y(d => y(d.resale_price));

    // 绘制每个地区的折线
    regions.forEach(region => {
        svg.append("path")
            .data([region.values])
            .attr("class", "line")
            .attr("d", line)
            .style("stroke", getColor(region.key)); // 为每个地区选择不同颜色
    });

    // 9. 添加图例
    const legend = svg.selectAll(".legend")
        .data(regions)
        .enter().append("g")
        .attr("class", "legend")
        .attr("transform", (d, i) => "translate(0," + i * 20 + ")");

    legend.append("rect")
        .attr("x", width - 18)
        .attr("width", 18)
        .attr("height", 18)
        .style("fill", d => getColor(d.key));

    legend.append("text")
        .attr("x", width - 24)
        .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "end")
        .text(d => d.key);

    // 辅助函数：为每个地区设置颜色
    function getColor(region) {
        const colors = {
            "WOODLANDS": "steelblue",
            "JURONG WEST": "green",
            "TAMPINES": "orange",
            "YISHUN": "red",
            "BEDOK": "purple",
            "SENGKANG": "brown",
            "HOUGANG": "pink",
            "ANG MO KIO": "yellow"
        };
        return colors[region] || "gray";
    }
});
</script>

</body>
</html>


