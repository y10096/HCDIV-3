<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>转售价格折线图</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .line {
            fill: none;
            stroke-width: 2;
        }
        .axis path, .axis line {
            fill: none;
            shape-rendering: crispEdges;
        }
        .axis text {
            font-size: 12px;
        }
        .legend {
            font-size: 12px;
        }
    </style>
</head>
<body>

<h2>2012年3月到2013年3月转售价格折线图</h2>
<svg width="960" height="500"></svg>

<script>
d3.csv("https://raw.githubusercontent.com/y10096/HCDIV-3/refs/heads/main/ResaleFlatPricesBasedonRegistrationDateFromMar2012toDec2014%20(1).csv").then(function(data) {

    const parseDate = d3.timeParse("%Y/%m/%d");

    const selectedRegions = ["WOODLANDS", "JURONG WEST", "TAMPINES", "YISHUN", "BEDOK", "SENGKANG", "HOUGANG", "ANG MO KIO"];
    
    data = data.filter(d => selectedRegions.includes(d.town))
               .map(d => {
                   d.month = parseDate(d.month);  // 将日期字段转为 Date 类型
                   d.resale_price = +d.resale_price; // 将价格转为数字
                   return d;
               });

    // 按月对每个地区的数据进行聚合（以每月的总价格为例）
    const monthlyData = d3.nest()
        .key(d => d.town) // 按地区分组
        .key(d => d.month.getFullYear() + "/" + (d.month.getMonth() + 1)) // 按年-月分组
        .rollup(values => {
            // 对每月的数据计算总转售价格
            const totalPrice = d3.sum(values, d => d.resale_price);
            return totalPrice;
        })
        .entries(data);

    // 设置图表的尺寸和边距
    const margin = { top: 20, right: 30, bottom: 40, left: 40 };
    const width = 960 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    // 创建 SVG 容器
    const svg = d3.select("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // 设置 x 和 y 轴的比例尺
    const x = d3.scaleTime()
        .range([0, width]);

    const y = d3.scaleLinear()
        .range([height, 0]);

    
    const allData = [];
    monthlyData.forEach(region => {
        region.values.forEach(d => {
            allData.push({
                town: region.key,
                month: parseDate(d.key), 
                resale_price: d.value 
            });
        });
    });

    
    x.domain(d3.extent(allData, d => d.month));
    y.domain([d3.min(allData, d => d.resale_price), d3.max(allData, d => d.resale_price)]);

    
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x).ticks(d3.timeMonth));

    svg.append("g")
        .attr("class", "y axis")
        .call(d3.axisLeft(y).ticks(5));

    
    const line = d3.line()
        .x(d => x(d.month))
        .y(d => y(d.resale_price));

    monthlyData.forEach(region => {
        svg.append("path")
            .data([region.values])
            .attr("class", "line")
            .attr("d", d3.line()
                .x(d => x(parseDate(d.key))) 
                .y(d => y(d.value))
            )
            .style("stroke", getColor(region.key));
    });

    
    const legend = svg.selectAll(".legend")
        .data(monthlyData)
        .enter().append("g")
        .attr("class", "legend")
        .attr("transform", (d, i) => "translate(0," + i * 20 + ")");

    legend.append("rect")
        .attr("x", width - 18)
        .attr("width", 18)
        .attr("height", 18)
        .style("fill", d => getColor(d.key));

    legend.append("text")
        .attr("x", width - 24)
        .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "end")
        .text(d => d.key);

    
    function getColor(region) {
        const colors = {
            "WOODLANDS": "steelblue",
            "JURONG WEST": "green",
            "TAMPINES": "orange",
            "YISHUN": "red",
            "BEDOK": "purple",
            "SENGKANG": "brown",
            "HOUGANG": "pink",
            "ANG MO KIO": "yellow"
        };
        return colors[region] || "gray";
    }
});
</script>

</body>
</html>
